// Copyright (c) 2018, 2025, Oracle and/or its affiliates.

//-----------------------------------------------------------------------------
//
// This software is dual-licensed to you under the Universal Permissive License
// (UPL) 1.0 as shown at https://oss.oracle.com/licenses/upl and Apache License
// 2.0 as shown at http://www.apache.org/licenses/LICENSE-2.0. You may choose
// either license.
//
// If you elect to accept the software under the Apache License, Version 2.0,
// the following applies:
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//    https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
// NAME
//   njsSodaDocument.c
//
// DESCRIPTION
//   SodaDocument class implementation.
//
//-----------------------------------------------------------------------------

#include "njsModule.h"

// class methods
NJS_NAPI_METHOD_DECL_SYNC(njsSodaDocument_getContent);
NJS_NAPI_METHOD_DECL_SYNC(njsSodaDocument_getCreatedOn);
NJS_NAPI_METHOD_DECL_SYNC(njsSodaDocument_getKey);
NJS_NAPI_METHOD_DECL_SYNC(njsSodaDocument_getLastModified);
NJS_NAPI_METHOD_DECL_SYNC(njsSodaDocument_getMediaType);
NJS_NAPI_METHOD_DECL_SYNC(njsSodaDocument_getVersion);

// finalize
static NJS_NAPI_FINALIZE(njsSodaDocument_finalize);

// properties defined by the class
static const napi_property_descriptor njsClassProperties[] = {
    { "getContent", NULL, njsSodaDocument_getContent,
            NULL, NULL, NULL, napi_default, NULL },
    { "getCreatedOn", NULL, njsSodaDocument_getCreatedOn, NULL, NULL, NULL,
            napi_default, NULL },
    { "getKey", NULL, njsSodaDocument_getKey, NULL, NULL, NULL, napi_default,
            NULL },
    { "getLastModified", NULL, njsSodaDocument_getLastModified, NULL, NULL,
            NULL, napi_default, NULL },
    { "getMediaType", NULL, njsSodaDocument_getMediaType, NULL, NULL, NULL,
            napi_default, NULL },
    { "getVersion", NULL, njsSodaDocument_getVersion, NULL, NULL, NULL,
            napi_default, NULL },
    { NULL, NULL, NULL, NULL, NULL, NULL, napi_default, NULL }
};

// class definition
const njsClassDef njsClassDefSodaDocument = {
    "SodaDocumentImpl", sizeof(njsSodaDocument), njsSodaDocument_finalize,
    njsClassProperties, false
};

// other methods used internally
static bool njsSodaDocument_genericGetter(napi_env env,
        njsModuleGlobals *globals, void *instance,
        int (*dpiGetterFn)(dpiSodaDoc*, const char**, uint32_t *),
        napi_value *returnValue);


//-----------------------------------------------------------------------------
// njsSodaDocument_createFromHandle()
//   Creates a new SODA document object given the ODPI-C handle.
//-----------------------------------------------------------------------------
bool njsSodaDocument_createFromHandle(napi_env env, dpiSodaDoc *handle,
        njsModuleGlobals *globals, napi_value *docObj)
{
    njsSodaDocument *doc;

    // create new instance
    if (!njsUtils_genericNew(env, &njsClassDefSodaDocument,
            globals->jsSodaDocumentConstructor, docObj, (void**) &doc))
        return false;

    // perform initializations
    doc->handle = handle;

    return true;
}


//-----------------------------------------------------------------------------
// njsSodaDocument_finalize()
//   Invoked when the njsSodaDocument object is garbage collected.
//-----------------------------------------------------------------------------
static void njsSodaDocument_finalize(napi_env env, void *finalizeData,
        void *finalizeHint)
{
    njsSodaDocument *doc = (njsSodaDocument*) finalizeData;

    if (doc->handle) {
        dpiSodaDoc_release(doc->handle);
        doc->handle = NULL;
    }
    free(doc);
}


//-----------------------------------------------------------------------------
// njsSodaDocument_genericGetter()
//   Generic function which performs the work of getting an attribute from the
// SODA document.
//-----------------------------------------------------------------------------
static bool njsSodaDocument_genericGetter(napi_env env,
        njsModuleGlobals *globals, void *instance,
        int (*dpiGetterFn)(dpiSodaDoc*, const char**, uint32_t *),
        napi_value *returnValue)
{
    njsSodaDocument *doc = (njsSodaDocument*) instance;
    uint32_t valueLength;
    const char *value;

    if ((*dpiGetterFn)(doc->handle, &value, &valueLength) < 0)
        return njsUtils_throwErrorDPI(env, globals);
    if (valueLength == 0) {
        NJS_CHECK_NAPI(env, napi_get_null(env, returnValue))
    } else {
        NJS_CHECK_NAPI(env, napi_create_string_utf8(env, value, valueLength,
                returnValue))
    }

    return true;
}


//-----------------------------------------------------------------------------
// njsSodaDocument_getContent()
//   Returns the contents of the SODA document as a JSON Document (Oracle
//   Client 23ai) or as a string.
//-----------------------------------------------------------------------------
NJS_NAPI_METHOD_IMPL_SYNC(njsSodaDocument_getContent, 0, NULL)
{
    njsSodaDocument *doc = (njsSodaDocument*) callingInstance;
    const char *value, *encoding, *mediaType;
    uint32_t valueLength, mediaTypeLength;
    dpiJson *json;
    dpiJsonNode *jsonNode;
    njsJsContext jsContext;
    bool isJson;

    if (dpiSodaDoc_getIsJson(doc->handle, (int*) &isJson) < 0)
        return njsUtils_throwErrorDPI(env, globals);

    if (isJson) {
        if (dpiSodaDoc_getJsonContent(doc->handle, &json) < 0)
            return njsUtils_throwErrorDPI(env, globals);
        if (dpiJson_getValue(json, DPI_JSON_OPT_DEFAULT, &jsonNode) < 0)
            return njsUtils_throwErrorDPI(env, globals);
        if (!njsJsContext_populate(env, globals, &jsContext))
            return false;
        if (!njsJsContext_getJsonNodeValue(&jsContext, jsonNode, env,
                returnValue))
            return false;
    } else {
        if (dpiSodaDoc_getContent(doc->handle, &value, &valueLength,
                &encoding) < 0)
            return njsUtils_throwErrorDPI(env, globals);
        if (valueLength == 0) {
            NJS_CHECK_NAPI(env, napi_get_null(env, returnValue))
            return true;
        }

        //get the mediaType to fetch the correct data
        if (dpiSodaDoc_getMediaType(doc->handle, (const char**) &mediaType,
                (uint32_t*) &mediaTypeLength) < 0)
            return njsUtils_throwErrorDPI(env, globals);

        if (strcmp(mediaType, "application/json") == 0) {
            if (!encoding || strcmp(encoding, "UTF-8") == 0) {
                NJS_CHECK_NAPI(env, napi_create_string_utf8(env, value, valueLength,
                        returnValue))
            } else {
                NJS_CHECK_NAPI(env, napi_create_string_utf16(env, (char16_t*) value,
                        (size_t) (valueLength / 2), returnValue))
            }

        // fetch non-JSON content
        } else {
            NJS_CHECK_NAPI(env, napi_create_buffer_copy(env, valueLength, value, NULL,
                    returnValue))
        }
    }

    return true;
}


//-----------------------------------------------------------------------------
// njsSodaDocument_getCreatedOn()
//   Get accessor of "createdOn" property.
//-----------------------------------------------------------------------------
NJS_NAPI_METHOD_IMPL_SYNC(njsSodaDocument_getCreatedOn, 0, NULL)
{
    return njsSodaDocument_genericGetter(env, globals, callingInstance,
            dpiSodaDoc_getCreatedOn, returnValue);
}


//-----------------------------------------------------------------------------
// njsSodaDocument_getKey()
//   Get accessor of "key" property.
//-----------------------------------------------------------------------------
NJS_NAPI_METHOD_IMPL_SYNC(njsSodaDocument_getKey, 0, NULL)
{
    return njsSodaDocument_genericGetter(env, globals, callingInstance,
            dpiSodaDoc_getKey, returnValue);
}


//-----------------------------------------------------------------------------
// njsSodaDocument_getLastModified()
//   Get accessor of "lastModified" property.
//-----------------------------------------------------------------------------
NJS_NAPI_METHOD_IMPL_SYNC(njsSodaDocument_getLastModified, 0, NULL)
{
    return njsSodaDocument_genericGetter(env, globals, callingInstance,
            dpiSodaDoc_getLastModified, returnValue);
}


//-----------------------------------------------------------------------------
// njsSodaDocument_getMediaType()
//   Get accessor of "mediaType" property.
//-----------------------------------------------------------------------------
NJS_NAPI_METHOD_IMPL_SYNC(njsSodaDocument_getMediaType, 0, NULL)
{
    return njsSodaDocument_genericGetter(env, globals, callingInstance,
            dpiSodaDoc_getMediaType, returnValue);
}


//-----------------------------------------------------------------------------
// njsSodaDocument_getVersion()
//   Get accessor of "version" property.
//-----------------------------------------------------------------------------
NJS_NAPI_METHOD_IMPL_SYNC(njsSodaDocument_getVersion, 0, NULL)
{
    return njsSodaDocument_genericGetter(env, globals, callingInstance,
            dpiSodaDoc_getVersion, returnValue);
}
